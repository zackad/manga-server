#!/usr/bin/env sh

# Prepare build target directory
rm -fr build/manga-server
mkdir -p build/manga-server

# Build frontend artifact
yarn build

# Copy artifact into dist directory
cp -r bin config public src templates composer.json composer.lock build/manga-server

# Define environment variable
echo "APP_ENV=prod" > build/manga-server/.env
echo "APP_SECRET=$(openssl rand -hex 20)" >> build/manga-server/.env
echo "MANGA_ROOT_DIRECTORY=/" >> build/manga-server/.env
echo "MAXIMUM_SEARCH_DEPTH=3" >> build/manga-server/.env

# Install dependencies and warm up cache
cd build/manga-server \
  && composer install --no-dev \
  && bin/console cache:clear --env prod \
  && cd ../..

# Remove unnecessary binary
cd build/manga-server \
  && rm -fr bin/build bin/phpunit bin/release composer.lock \
  && cd ../..

# Remove php_cs cache
find build -type f -name "*.cache" -exec rm {} \;
